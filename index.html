<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나도 멋진 친구! 색깔 찾아주기 비밀 작전 (개선버전)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            max-width: 960px;
            margin: 20px auto;
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        header h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2.2em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 진행률 표시기 */
        .progress-container {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px solid #dee2e6;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 6px;
            transition: width 0.5s ease;
            width: 33.33%;
            position: relative;
        }

        .progress-fill::after {
            content: '✨';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            color: #ffd700;
            font-size: 16px;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.5; transform: translateY(-50%) scale(1.2); }
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
            color: #6c757d;
            gap: 10px;
        }

        .progress-step {
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .progress-step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            border-color: #5a67d8;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .progress-step.completed {
            background-color: #28a745;
            color: white;
            border-color: #20c997;
        }

        /* 키보드 네비게이션 안내 */
        .keyboard-navigation-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 2px solid #bee5eb;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            color: #0c5460;
            margin-bottom: 20px;
            position: relative;
        }

        .keyboard-navigation-info::before {
            content: '⌨️';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
        }

        .input-section {
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fdfdff, #f8f9fa);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .input-section h2 {
            font-size: 1.6em;
            color: #2c3e50;
            margin: 0 0 20px 0;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.2em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .step1-icon { background: linear-gradient(135deg, #667eea, #764ba2); }
        .step2-icon { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .step3-icon { background: linear-gradient(135deg, #ffecd2, #fcb69f); color: #d35400; }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .input-group input[type="text"],
        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-size: 1em;
            box-sizing: border-box;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .input-group input[type="text"]:focus,
        .input-group textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
            transform: translateY(-2px);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* 입력 유효성 피드백 */
        .input-feedback {
            font-size: 0.85em;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            display: none;
            font-weight: 500;
        }

        .input-feedback.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .input-feedback.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* 이미지 업로드 */
        .image-upload-group {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f9f9f9, #f1f3f4);
            border: 3px dashed #ced4da;
            border-radius: 12px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .image-upload-group:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e8f2ff);
        }

        .image-upload-group input[type="file"] {
            display: block;
            margin: 10px auto;
            font-size: 0.9em;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-group input[type="file"]:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .image-preview {
            max-width: 250px;
            max-height: 250px;
            margin: 15px auto;
            border: 3px solid #ddd;
            padding: 8px;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .image-preview img {
            max-width: 100%;
            max-height: 230px;
            border-radius: 8px;
        }

        .clear-image-btn {
            font-size: 0.9em;
            padding: 8px 16px;
            margin-top: 10px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .clear-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        /* 툴팁 */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* 네비게이션 버튼 */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* 도구 모음 */
        .toolbar {
            text-align: center;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid #e0e0e0;
        }

        .toolbar button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            min-width: 120px;
        }

        .toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .toolbar button.reset {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .toolbar button.reset:hover {
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
        }

        .toolbar button.preview-toggle-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .toolbar button.preview-toggle-btn:hover {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        /* 미리보기 영역 */
        #previewAreaContainer {
            margin-top: 30px;
            padding: 25px;
            border: 3px dashed #bdc3c7;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        #previewAreaContainer h3 {
            text-align: center;
            margin: 0 0 25px 0;
            color: #2c3e50;
            font-size: 1.4em;
        }

        #previewArea {
            border: 2px solid #abb2b9;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #previewArea .info-display {
            font-size: 1em;
            color: #2c3e50;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 2px dashed #ecf0f1;
        }

        #previewArea .phase-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ecf0f1;
        }

        #previewArea .phase-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        #previewArea .phase-section h4 {
            font-size: 1.4em;
            color: #667eea;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #previewArea .phase-section p {
            margin: 10px 0;
            font-size: 1em;
            line-height: 1.7;
            color: #333;
        }

        #previewArea .phase-section strong {
            color: #2c3e50;
            font-weight: 600;
        }

        #previewArea .phase-section .uploaded-image {
            max-width: 200px;
            max-height: 200px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* 로딩 인디케이터 */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 15px;
            z-index: 1000;
            font-size: 1.2em;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }

        .loading::before {
            content: '🔄';
            display: block;
            font-size: 2em;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 완료 메시지 */
        .completion-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .completion-message h2 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .completion-message p {
            color: #155724;
            font-size: 1.1em;
            margin-bottom: 25px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            header h1 {
                font-size: 1.8em;
            }

            .progress-steps {
                font-size: 0.8em;
                flex-direction: column;
                gap: 5px;
            }

            .progress-step {
                padding: 6px 10px;
            }

            .navigation-buttons {
                flex-direction: column;
            }

            .toolbar {
                text-align: left;
            }

            .toolbar button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }
        }

        /* 접근성 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* 고대비 모드 지원 */
        @media (prefers-contrast: high) {
            .input-group input[type="text"],
            .input-group textarea {
                border-width: 3px;
            }
        }

        /* 모션 줄이기 선호 설정 지원 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingIndicator" role="status" aria-live="polite">
        <span class="sr-only">로딩 중</span>
        처리 중... 잠시만 기다려주세요.
    </div>

    <div class="container">
        <header>
            <h1>나도 멋진 친구! 내 친구의 '색깔'을 찾아주는 비밀 작전! 🌟</h1>
        </header>

        <!-- 진행률 표시기 -->
        <div class="progress-container">
            <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="33">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
                <span class="progress-step active" id="step1">🪄 작전 1: 마법 주문</span>
                <span class="progress-step" id="step2">🕵️ 작전 2: 비밀 행동</span>
                <span class="progress-step" id="step3">🌟 최종 작전: 나의 약속</span>
            </div>
        </div>

        <!-- 키보드 네비게이션 안내 -->
        <div class="keyboard-navigation-info">
            💡 <strong>키보드 사용법:</strong> Tab/Shift+Tab으로 이동, Enter/Space로 선택, Ctrl+Enter로 다음 단계 이동
        </div>

        <!-- 기본 정보 섹션 -->
        <section class="input-section" id="basicInfoSection" role="region" aria-labelledby="basicInfoTitle">
            <h2 id="basicInfoTitle">
                <span class="section-icon step1-icon">📋</span>
                기본 정보
            </h2>
            <div class="input-group">
                <label for="studentInfo">학교, 학반, 이름:</label>
                <input type="text" id="studentInfo" placeholder="예: OO초등학교 4학년 2반 김민수"
                       aria-describedby="studentInfoFeedback" required>
                <div class="input-feedback" id="studentInfoFeedback"></div>
            </div>

            <div class="input-group">
                <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
                    <div style="display: flex; align-items: start; gap: 15px;">
                        <div style="font-size: 3em;">👦👧</div>
                        <div>
                            <p style="font-size: 1.1em; color: #2c3e50; margin: 0 0 10px 0;">
                                그림책 <strong>'보이지 않는 아이'</strong>의 브라이언은 친구 저스틴 덕분에 자신만의 아름다운 색깔을 찾았어요!
                            </p>
                            <p style="font-size: 1em; color: #34495e; margin: 0;">
                                우리도 주변 친구들이 아직 보여주지 않은 멋진 '색깔'을 발견하고, 활짝 빛날 수 있도록 도와주는
                                <strong style="color: #667eea;">'비밀 요원'</strong>이 되어 특별한 작전을 시작해 볼까요?
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 작전 1: 마법 주문 -->
        <section id="magicWordsSection" class="input-section" role="region" aria-labelledby="magicTitle">
            <h2 id="magicTitle">
                <span class="section-icon step1-icon">🪄</span>
                작전 1: 친구에게 힘을 주는 '마법 주문' (말) ✍️
            </h2>

            <div style="background: linear-gradient(135deg, #f0f4ff, #e8f2ff); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <p style="font-size: 1.1em; color: #2c3e50; margin: 0 0 15px 0;">
                    친구가 기운을 내고 활짝 웃을 수 있게 도와주는 '마법 주문' 같은 말을 3가지 생각해 적어보세요.
                    어떤 말을 해주면 친구의 마음속에 예쁜 색깔이 피어날까요?
                </p>

                <div class="tooltip">
                    <span style="color: #667eea; cursor: help; border-bottom: 2px dotted #667eea; font-weight: 600;">
                        💡 힌트가 필요하다면 여기를 보세요!
                    </span>
                    <div class="tooltip-text">
                        예: '네 생각 정말 멋지다!', '너랑 같이 있으면 항상 즐거워!', '괜찮아, 내가 옆에 있을게!'
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="magicWord1">마법 주문 1:</label>
                <input type="text" id="magicWord1" placeholder="친구에게 힘을 주는 따뜻한 말을 적어보세요..."
                       aria-describedby="magicWord1Feedback" maxlength="50">
                <div class="input-feedback" id="magicWord1Feedback"></div>
            </div>

            <div class="input-group">
                <label for="magicWord2">마법 주문 2:</label>
                <input type="text" id="magicWord2" placeholder="또 다른 마법 주문을 생각해보세요..."
                       aria-describedby="magicWord2Feedback" maxlength="50">
                <div class="input-feedback" id="magicWord2Feedback"></div>
            </div>

            <div class="input-group">
                <label for="magicWord3">마법 주문 3:</label>
                <input type="text" id="magicWord3" placeholder="세 번째 마법 주문을 적어보세요..."
                       aria-describedby="magicWord3Feedback" maxlength="50">
                <div class="input-feedback" id="magicWord3Feedback"></div>
            </div>

            <div class="input-group">
                <label for="magicWordImage">🎨 마법 주문을 표현하는 그림이나 사진 (선택사항):</label>
                <div class="image-upload-group">
                    <p style="color: #6c757d; margin: 0 0 10px 0;">
                        📸 친구에게 힘을 주는 마법 주문을 그림으로 그리거나 관련 사진을 올려보세요!
                    </p>
                    <input type="file" id="magicWordImageUpload" accept="image/*" aria-describedby="magicWordImageHelp">
                    <div id="magicWordImageHelp" class="sr-only">이미지 파일을 선택하여 업로드하세요</div>
                    <div class="image-preview" id="magicWordImagePreviewContainer" style="display:none;" role="img" aria-label="업로드된 이미지 미리보기">
                        <img id="magicWordImagePreview" src="#" alt="마법 주문 관련 이미지 미리보기">
                    </div>
                    <button type="button" id="clearMagicWordImageBtn" class="clear-image-btn" style="display:none;" aria-label="첨부된 이미지 삭제">
                        첨부 이미지 지우기
                    </button>
                </div>
            </div>

            <div class="navigation-buttons">
                <button type="button" id="magicToSecretBtn" class="action-btn" aria-label="2단계로 이동: 비밀 행동">
                    다음 작전 (비밀 행동) 🕵️
                </button>
            </div>
        </section>

        <!-- 작전 2: 비밀 행동 -->
        <section id="secretActionsSection" class="input-section" style="display:none;" role="region" aria-labelledby="secretTitle">
            <h2 id="secretTitle">
                <span class="section-icon step2-icon">🕵️</span>
                작전 2: 친구를 웃게 하는 '비밀 행동' (행동) 🏃‍♂️💨
            </h2>

            <div style="background: linear-gradient(135deg, #e8f5e8, #f0fff0); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <p style="font-size: 1.1em; color: #2c3e50; margin: 0 0 15px 0;">
                    말뿐만 아니라, 어떤 '비밀 행동'으로 친구를 기분 좋게 하고 그 친구만의 특별한 색깔을 찾아줄 수 있을까요?
                    나만의 특별한 행동 3가지를 적어보세요.
                </p>

                <div class="tooltip">
                    <span style="color: #11998e; cursor: help; border-bottom: 2px dotted #11998e; font-weight: 600;">
                        💡 힌트가 필요하다면 여기를 보세요!
                    </span>
                    <div class="tooltip-text">
                        예: 먼저 다가가 웃으며 인사하기, 도움이 필요해 보일 때 슬쩍 도와주기, 함께 재미있는 놀이하기
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="secretAction1">비밀 행동 1:</label>
                <input type="text" id="secretAction1" placeholder="친구를 기분 좋게 하는 행동을 적어보세요..."
                       aria-describedby="secretAction1Feedback" maxlength="50">
                <div class="input-feedback" id="secretAction1Feedback"></div>
            </div>

            <div class="input-group">
                <label for="secretAction2">비밀 행동 2:</label>
                <input type="text" id="secretAction2" placeholder="또 다른 비밀 행동을 생각해보세요..."
                       aria-describedby="secretAction2Feedback" maxlength="50">
                <div class="input-feedback" id="secretAction2Feedback"></div>
            </div>

            <div class="input-group">
                <label for="secretAction3">비밀 행동 3:</label>
                <input type="text" id="secretAction3" placeholder="세 번째 비밀 행동을 적어보세요..."
                       aria-describedby="secretAction3Feedback" maxlength="50">
                <div class="input-feedback" id="secretAction3Feedback"></div>
            </div>

            <div class="input-group">
                <label for="secretActionImage">🎨 비밀 행동을 표현하는 그림이나 사진 (선택사항):</label>
                <div class="image-upload-group">
                    <p style="color: #6c757d; margin: 0 0 10px 0;">
                        📸 친구를 웃게 하는 비밀 행동을 그림으로 그리거나 관련 사진을 올려보세요!
                    </p>
                    <input type="file" id="secretActionImageUpload" accept="image/*" aria-describedby="secretActionImageHelp">
                    <div id="secretActionImageHelp" class="sr-only">이미지 파일을 선택하여 업로드하세요</div>
                    <div class="image-preview" id="secretActionImagePreviewContainer" style="display:none;" role="img" aria-label="업로드된 이미지 미리보기">
                        <img id="secretActionImagePreview" src="#" alt="비밀 행동 관련 이미지 미리보기">
                    </div>
                    <button type="button" id="clearSecretActionImageBtn" class="clear-image-btn" style="display:none;" aria-label="첨부된 이미지 삭제">
                        첨부 이미지 지우기
                    </button>
                </div>
            </div>

            <div class="navigation-buttons">
                <button type="button" id="secretToMagicBtn" class="action-btn" aria-label="1단계로 돌아가기: 마법 주문">
                    이전 작전 (마법 주문) 🪄
                </button>
                <button type="button" id="secretToPromiseBtn" class="action-btn" aria-label="3단계로 이동: 나의 약속">
                    최종 작전 (나의 약속) 🌟
                </button>
            </div>
        </section>

        <!-- 작전 3: 최종 약속 -->
        <section id="finalPromiseSection" class="input-section" style="display:none;" role="region" aria-labelledby="promiseTitle">
            <h2 id="promiseTitle">
                <span class="section-icon step3-icon">🌟</span>
                최종 작전: 나의 빛나는 '색깔 찾아주기' 약속! 🌟
            </h2>

            <div style="background: linear-gradient(135deg, #fff3e0, #ffeaa7); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <p style="font-size: 1.1em; color: #2c3e50; margin: 0;">
                    이제 위에서 생각한 마법 주문과 비밀 행동들을 바탕으로, 앞으로 친구의 '색깔'을 찾아주기 위해
                    내가 꼭 실천하고 싶은 가장 중요한 약속 한 가지를 정해서 적어주세요!
                </p>
            </div>

            <!-- 요약 영역 -->
            <div id="summaryArea" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <h4 style="color: #2c3e50; margin: 0 0 15px 0; text-align: center;">📝 내가 생각한 작전들 요약</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                        <strong style="color: #667eea;">🪄 마법 주문들</strong>
                        <p id="summaryMagicWords" style="margin: 10px 0 0 0; font-size: 0.9em; color: #555;"></p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #11998e;">
                        <strong style="color: #11998e;">🕵️ 비밀 행동들</strong>
                        <p id="summarySecretActions" style="margin: 10px 0 0 0; font-size: 0.9em; color: #555;"></p>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="finalPromise">나의 소중한 약속:</label>
                <div style="background: linear-gradient(135deg, #fef7cd, #fff8dc); border: 3px solid #d4a574; border-radius: 15px; padding: 20px; position: relative;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span style="font-size: 1.2em; color: #8b4513; font-weight: bold;">📜 나의 소중한 약속서 📜</span>
                    </div>
                    <textarea id="finalPromise" placeholder="친구의 색깔을 찾아주기 위해 내가 꼭 실천하고 싶은 약속을 적어주세요..."
                              rows="5" style="background: rgba(255,255,255,0.9); border: 2px solid #d4a574;"
                              aria-describedby="finalPromiseFeedback" maxlength="200"></textarea>
                    <div class="input-feedback" id="finalPromiseFeedback"></div>
                </div>
            </div>

            <div class="input-group">
                <label for="promiseImage">🎨 나의 약속을 표현하는 그림이나 사진 (선택사항):</label>
                <div class="image-upload-group">
                    <p style="color: #6c757d; margin: 0 0 10px 0;">
                        📸 나의 소중한 약속을 그림으로 그리거나 관련 사진을 올려보세요!
                    </p>
                    <input type="file" id="promiseImageUpload" accept="image/*" aria-describedby="promiseImageHelp">
                    <div id="promiseImageHelp" class="sr-only">이미지 파일을 선택하여 업로드하세요</div>
                    <div class="image-preview" id="promiseImagePreviewContainer" style="display:none;" role="img" aria-label="업로드된 이미지 미리보기">
                        <img id="promiseImagePreview" src="#" alt="약속 관련 이미지 미리보기">
                    </div>
                    <button type="button" id="clearPromiseImageBtn" class="clear-image-btn" style="display:none;" aria-label="첨부된 이미지 삭제">
                        첨부 이미지 지우기
                    </button>
                </div>
            </div>

            <div class="navigation-buttons">
                <button type="button" id="promiseToSecretBtn" class="action-btn" aria-label="2단계로 돌아가기: 비밀 행동">
                    이전 작전 (비밀 행동) 🕵️
                </button>
                <button type="button" id="completeBtn" class="action-btn" style="background: linear-gradient(135deg, #f39c12, #e67e22);" aria-label="비밀 작전 완료">
                    🎉 비밀 작전 완료! 🎉
                </button>
            </div>
        </section>

        <!-- 완료 메시지 -->
        <div id="completionMessage" class="completion-message" style="display:none;">
            <div style="font-size: 4em; margin-bottom: 20px;">🎊✨🌟</div>
            <h2>축하해요! 🎉</h2>
            <p>
                친구의 색깔을 찾아주는 멋진 <strong style="color: #667eea;">비밀 요원</strong>이 되었어요!<br>
                당신의 따뜻한 마음이 친구들에게 잘 전달될 거예요.
            </p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button id="printBtn" class="action-btn" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                    📄 나의 약속 카드 인쇄하기
                </button>
                <button id="newMissionBtn" class="action-btn" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                    🔄 새로운 작전 시작하기
                </button>
            </div>
        </div>

        <!-- 도구 모음 -->
        <div class="toolbar" role="toolbar" aria-label="학습지 도구">
            <button id="togglePreviewBtn" class="preview-toggle-btn" aria-label="미리보기 표시/숨기기">
                📋 미리보기 보기/숨기기
            </button>
            <button id="saveAsImageBtn" aria-label="완성된 학습지를 이미지 파일로 저장">
                🖼️ 이미지로 저장
            </button>
            <button id="saveAsPdfBtn" aria-label="완성된 학습지를 PDF 파일로 저장">
                📄 PDF로 저장
            </button>
            <button id="resetBtn" class="reset" aria-label="모든 입력 내용 초기화">
                🆕 새로 작성
            </button>
        </div>

        <!-- 미리보기 영역 -->
        <div id="previewAreaContainer" style="display:none;" role="region" aria-labelledby="previewTitle">
            <h3 id="previewTitle">📋 미리보기 (이 영역이 이미지/PDF로 저장됩니다)</h3>
            <div id="previewArea">
                <div class="info-display">
                    <p><strong>학교, 학반, 이름:</strong> <span id="previewStudentInfo"></span></p>
                </div>

                <div class="phase-section">
                    <h4>🪄 친구에게 힘을 주는 마법 주문</h4>
                    <p><strong>마법 주문 1:</strong> <span id="previewMagicWord1"></span></p>
                    <p><strong>마법 주문 2:</strong> <span id="previewMagicWord2"></span></p>
                    <p><strong>마법 주문 3:</strong> <span id="previewMagicWord3"></span></p>
                    <img id="previewMagicWordImage" src="#" alt="마법 주문 관련 이미지" class="uploaded-image" style="display: none;">
                </div>

                <div class="phase-section">
                    <h4>🕵️ 친구를 웃게 하는 비밀 행동</h4>
                    <p><strong>비밀 행동 1:</strong> <span id="previewSecretAction1"></span></p>
                    <p><strong>비밀 행동 2:</strong> <span id="previewSecretAction2"></span></p>
                    <p><strong>비밀 행동 3:</strong> <span id="previewSecretAction3"></span></p>
                    <img id="previewSecretActionImage" src="#" alt="비밀 행동 관련 이미지" class="uploaded-image" style="display: none;">
                </div>

                <div class="phase-section">
                    <h4>🌟 나의 소중한 약속</h4>
                    <div style="background: linear-gradient(135deg, #fef7cd, #fff8dc); border: 2px solid #d4a574; border-radius: 10px; padding: 20px; margin: 15px 0;">
                        <p id="previewFinalPromise" style="font-size: 1.1em; font-weight: 500; line-height: 1.8; color: #8b4513; margin: 0;"></p>
                    </div>
                    <img id="previewPromiseImage" src="#" alt="약속 관련 이미지" class="uploaded-image" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        class FriendshipMissionApp {
            constructor() {
                this.currentStep = 1;
                this.appState = {
                    studentInfo: '',
                    magicWords: ['', '', ''],
                    secretActions: ['', '', ''],
                    finalPromise: '',
                    images: {
                        magicWord: null,
                        secretAction: null,
                        promise: null
                    }
                };

                this.initializeElements();
                this.setupEventListeners();
                this.setupKeyboardNavigation();
                this.updateProgress();
                this.loadSavedData();
            }

            initializeElements() {
                // 기본 정보 요소들
                this.elements = {
                    studentInfo: document.getElementById('studentInfo'),
                    
                    // 마법 주문 요소들
                    magicWord1: document.getElementById('magicWord1'),
                    magicWord2: document.getElementById('magicWord2'),
                    magicWord3: document.getElementById('magicWord3'),
                    magicWordImageUpload: document.getElementById('magicWordImageUpload'),
                    magicWordImagePreview: document.getElementById('magicWordImagePreview'),
                    magicWordImagePreviewContainer: document.getElementById('magicWordImagePreviewContainer'),
                    clearMagicWordImageBtn: document.getElementById('clearMagicWordImageBtn'),
                    
                    // 비밀 행동 요소들
                    secretAction1: document.getElementById('secretAction1'),
                    secretAction2: document.getElementById('secretAction2'),
                    secretAction3: document.getElementById('secretAction3'),
                    secretActionImageUpload: document.getElementById('secretActionImageUpload'),
                    secretActionImagePreview: document.getElementById('secretActionImagePreview'),
                    secretActionImagePreviewContainer: document.getElementById('secretActionImagePreviewContainer'),
                    clearSecretActionImageBtn: document.getElementById('clearSecretActionImageBtn'),
                    
                    // 최종 약속 요소들
                    finalPromise: document.getElementById('finalPromise'),
                    promiseImageUpload: document.getElementById('promiseImageUpload'),
                    promiseImagePreview: document.getElementById('promiseImagePreview'),
                    promiseImagePreviewContainer: document.getElementById('promiseImagePreviewContainer'),
                    clearPromiseImageBtn: document.getElementById('clearPromiseImageBtn'),
                    
                    // 진행률 및 미리보기 요소들
                    progressFill: document.getElementById('progressFill'),
                    step1: document.getElementById('step1'),
                    step2: document.getElementById('step2'),
                    step3: document.getElementById('step3'),
                    previewAreaContainer: document.getElementById('previewAreaContainer'),
                    previewArea: document.getElementById('previewArea'),
                    loadingIndicator: document.getElementById('loadingIndicator')
                };

                this.sections = {
                    basic: document.getElementById('basicInfoSection'),
                    magic: document.getElementById('magicWordsSection'),
                    secret: document.getElementById('secretActionsSection'),
                    promise: document.getElementById('finalPromiseSection')
                };

                this.buttons = {
                    magicToSecret: document.getElementById('magicToSecretBtn'),
                    secretToMagic: document.getElementById('secretToMagicBtn'),
                    secretToPromise: document.getElementById('secretToPromiseBtn'),
                    promiseToSecret: document.getElementById('promiseToSecretBtn'),
                    complete: document.getElementById('completeBtn'),
                    togglePreview: document.getElementById('togglePreviewBtn'),
                    saveAsImage: document.getElementById('saveAsImageBtn'),
                    saveAsPdf: document.getElementById('saveAsPdfBtn'),
                    reset: document.getElementById('resetBtn'),
                    print: document.getElementById('printBtn'),
                    newMission: document.getElementById('newMissionBtn')
                };
            }

            setupEventListeners() {
                // 네비게이션 버튼들
                this.buttons.magicToSecret.addEventListener('click', () => this.goToStep(2));
                this.buttons.secretToMagic.addEventListener('click', () => this.goToStep(1));
                this.buttons.secretToPromise.addEventListener('click', () => this.goToStep(3));
                this.buttons.promiseToSecret.addEventListener('click', () => this.goToStep(2));
                this.buttons.complete.addEventListener('click', () => this.completeMission());

                // 이미지 업로드 이벤트들
                this.elements.magicWordImageUpload.addEventListener('change', (e) => 
                    this.handleImageUpload(e, 'magicWord'));
                this.elements.secretActionImageUpload.addEventListener('change', (e) => 
                    this.handleImageUpload(e, 'secretAction'));
                this.elements.promiseImageUpload.addEventListener('change', (e) => 
                    this.handleImageUpload(e, 'promise'));

                // 이미지 삭제 버튼들
                this.elements.clearMagicWordImageBtn.addEventListener('click', () => 
                    this.clearImage('magicWord'));
                this.elements.clearSecretActionImageBtn.addEventListener('click', () => 
                    this.clearImage('secretAction'));
                this.elements.clearPromiseImageBtn.addEventListener('click', () => 
                    this.clearImage('promise'));

                // 도구 버튼들
                this.buttons.togglePreview.addEventListener('click', () => this.togglePreview());
                this.buttons.saveAsImage.addEventListener('click', () => this.saveAsImage());
                this.buttons.saveAsPdf.addEventListener('click', () => this.saveAsPdf());
                this.buttons.reset.addEventListener('click', () => this.resetAll());
                this.buttons.print.addEventListener('click', () => this.printCard());
                this.buttons.newMission.addEventListener('click', () => this.resetAll());

                // 입력 유효성 검사
                this.setupValidation();

                // 실시간 상태 업데이트
                this.setupRealTimeUpdates();
            }

            setupValidation() {
                const validationRules = [
                    { element: this.elements.studentInfo, feedback: 'studentInfoFeedback', required: true },
                    { element: this.elements.magicWord1, feedback: 'magicWord1Feedback', required: true },
                    { element: this.elements.magicWord2, feedback: 'magicWord2Feedback', required: true },
                    { element: this.elements.magicWord3, feedback: 'magicWord3Feedback', required: true },
                    { element: this.elements.secretAction1, feedback: 'secretAction1Feedback', required: true },
                    { element: this.elements.secretAction2, feedback: 'secretAction2Feedback', required: true },
                    { element: this.elements.secretAction3, feedback: 'secretAction3Feedback', required: true },
                    { element: this.elements.finalPromise, feedback: 'finalPromiseFeedback', required: true }
                ];

                validationRules.forEach(rule => {
                    rule.element.addEventListener('blur', () => 
                        this.validateInput(rule.element, rule.feedback, rule.required));
                    rule.element.addEventListener('input', () => 
                        this.clearFeedback(rule.feedback));
                });
            }

            validateInput(element, feedbackId, required = true) {
                const feedback = document.getElementById(feedbackId);
                const value = element.value.trim();
                
                if (required && value.length === 0) {
                    this.showFeedback(feedback, '필수 입력 항목입니다.', 'error');
                    return false;
                } else if (required && value.length < 2) {
                    this.showFeedback(feedback, '최소 2글자 이상 입력해주세요.', 'error');
                    return false;
                } else if (value.length > 0) {
                    this.showFeedback(feedback, '입력이 완료되었습니다! ✨', 'success');
                    return true;
                }
                return true;
            }

            showFeedback(feedbackElement, message, type) {
                feedbackElement.textContent = message;
                feedbackElement.className = `input-feedback ${type}`;
                feedbackElement.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        feedbackElement.style.display = 'none';
                    }, 3000);
                }
            }

            clearFeedback(feedbackId) {
                const feedback = document.getElementById(feedbackId);
                feedback.style.display = 'none';
            }

            setupRealTimeUpdates() {
                const inputs = [
                    this.elements.studentInfo,
                    this.elements.magicWord1, this.elements.magicWord2, this.elements.magicWord3,
                    this.elements.secretAction1, this.elements.secretAction2, this.elements.secretAction3,
                    this.elements.finalPromise
                ];

                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.updateAppState();
                        this.saveData();
                    });
                });
            }

            setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        if (this.currentStep < 3) {
                            this.goToStep(this.currentStep + 1);
                        } else {
                            this.completeMission();
                        }
                    }
                    
                    if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                        e.preventDefault();
                        if (this.currentStep > 1) {
                            this.goToStep(this.currentStep - 1);
                        }
                    }
                });
            }

            updateAppState() {
                this.appState.studentInfo = this.elements.studentInfo.value;
                
                this.appState.magicWords = [
                    this.elements.magicWord1.value,
                    this.elements.magicWord2.value,
                    this.elements.magicWord3.value
                ];
                
                this.appState.secretActions = [
                    this.elements.secretAction1.value,
                    this.elements.secretAction2.value,
                    this.elements.secretAction3.value
                ];
                
                this.appState.finalPromise = this.elements.finalPromise.value;
            }

            handleImageUpload(event, imageType) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('이미지 파일은 5MB 이하만 업로드 가능합니다.');
                        event.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.appState.images[imageType] = e.target.result;
                        this.updateImagePreview(imageType, e.target.result);
                        this.saveData();
                    };
                    reader.readAsDataURL(file);
                } else {
                    this.clearImage(imageType);
                }
            }

            updateImagePreview(imageType, imageData) {
                const preview = this.elements[`${imageType}ImagePreview`];
                const container = this.elements[`${imageType}ImagePreviewContainer`];
                const clearBtn = this.elements[`clear${imageType.charAt(0).toUpperCase() + imageType.slice(1)}ImageBtn`];
                
                preview.src = imageData;
                container.style.display = 'flex';
                clearBtn.style.display = 'inline-block';
            }

            clearImage(imageType) {
                const preview = this.elements[`${imageType}ImagePreview`];
                const container = this.elements[`${imageType}ImagePreviewContainer`];
                const clearBtn = this.elements[`clear${imageType.charAt(0).toUpperCase() + imageType.slice(1)}ImageBtn`];
                const upload = this.elements[`${imageType}ImageUpload`];
                
                preview.src = '#';
                container.style.display = 'none';
                clearBtn.style.display = 'none';
                upload.value = '';
                this.appState.images[imageType] = null;
                this.saveData();
            }

            goToStep(step) {
                this.currentStep = step;
                this.updateProgress();
                
                // 모든 섹션 숨기기
                Object.values(this.sections).forEach(section => {
                    section.style.display = 'none';
                });
                
                // 현재 단계 섹션만 표시
                switch(step) {
                    case 1:
                        this.sections.basic.style.display = 'block';
                        this.sections.magic.style.display = 'block';
                        break;
                    case 2:
                        this.sections.secret.style.display = 'block';
                        break;
                    case 3:
                        this.updateSummary();
                        this.sections.promise.style.display = 'block';
                        break;
                }
                
                // 해당 섹션으로 스크롤
                const targetSection = step === 1 ? this.sections.magic : 
                                   step === 2 ? this.sections.secret : this.sections.promise;
                
                setTimeout(() => {
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // 첫 번째 입력 필드에 포커스
                    const firstInput = targetSection.querySelector('input, textarea');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 300);
            }

            updateProgress() {
                const progressPercent = (this.currentStep / 3) * 100;
                this.elements.progressFill.style.width = `${progressPercent}%`;
                
                const progressBar = document.querySelector('.progress-bar');
                progressBar.setAttribute('aria-valuenow', progressPercent);
                
                [this.elements.step1, this.elements.step2, this.elements.step3].forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index + 1 === this.currentStep) {
                        step.classList.add('active');
                    } else if (index + 1 < this.currentStep) {
                        step.classList.add('completed');
                    }
                });
            }

            updateSummary() {
                this.updateAppState();
                
                const magicWords = this.appState.magicWords.filter(word => word.trim()).join(', ') || '아직 입력하지 않음';
                const secretActions = this.appState.secretActions.filter(action => action.trim()).join(', ') || '아직 입력하지 않음';
                
                document.getElementById('summaryMagicWords').textContent = magicWords;
                document.getElementById('summarySecretActions').textContent = secretActions;
            }

            completeMission() {
                this.updateAppState();
                
                // 필수 입력 확인
                const requiredFields = [
                    { value: this.appState.studentInfo, name: '학생 정보' },
                    { value: this.appState.magicWords[0], name: '마법 주문 1' },
                    { value: this.appState.magicWords[1], name: '마법 주문 2' },
                    { value: this.appState.magicWords[2], name: '마법 주문 3' },
                    { value: this.appState.secretActions[0], name: '비밀 행동 1' },
                    { value: this.appState.secretActions[1], name: '비밀 행동 2' },
                    { value: this.appState.secretActions[2], name: '비밀 행동 3' },
                    { value: this.appState.finalPromise, name: '최종 약속' }
                ];
                
                const missingFields = requiredFields.filter(field => !field.value.trim());
                
                if (missingFields.length > 0) {
                    alert(`다음 항목들을 입력해주세요:\n${missingFields.map(field => field.name).join('\n')}`);
                    return;
                }
                
                // 완료 메시지 표시
                document.getElementById('completionMessage').style.display = 'block';
                document.getElementById('completionMessage').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                this.createSparkleEffect();
            }

            createSparkleEffect() {
                const sparkles = ['✨', '⭐', '🌟', '💫', '🎊'];
                const container = document.body;
                
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        const sparkle = document.createElement('div');
                        sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
                        sparkle.style.position = 'fixed';
                        sparkle.style.left = Math.random() * window.innerWidth + 'px';
                        sparkle.style.top = Math.random() * window.innerHeight + 'px';
                        sparkle.style.fontSize = '2em';
                        sparkle.style.zIndex = '9999';
                        sparkle.style.pointerEvents = 'none';
                        sparkle.style.animation = 'sparkleFloat 3s ease-out forwards';
                        
                        container.appendChild(sparkle);
                        
                        setTimeout(() => {
                            if (sparkle.parentNode) {
                                sparkle.parentNode.removeChild(sparkle);
                            }
                        }, 3000);
                    }, i * 100);
                }
                
                // CSS 애니메이션 추가
                if (!document.querySelector('#sparkleAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'sparkleAnimation';
                    style.textContent = `
                        @keyframes sparkleFloat {
                            0% { opacity: 1; transform: translateY(0px) scale(0); }
                            50% { opacity: 1; transform: translateY(-100px) scale(1.2); }
                            100% { opacity: 0; transform: translateY(-200px) scale(0); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            updatePreview() {
                this.updateAppState();
                
                // 기본 정보 업데이트
                document.getElementById('previewStudentInfo').textContent = 
                    this.appState.studentInfo || '입력하지 않음';
                
                // 마법 주문 업데이트
                document.getElementById('previewMagicWord1').textContent = 
                    this.appState.magicWords[0] || '입력하지 않음';
                document.getElementById('previewMagicWord2').textContent = 
                    this.appState.magicWords[1] || '입력하지 않음';
                document.getElementById('previewMagicWord3').textContent = 
                    this.appState.magicWords[2] || '입력하지 않음';
                
                // 비밀 행동 업데이트
                document.getElementById('previewSecretAction1').textContent = 
                    this.appState.secretActions[0] || '입력하지 않음';
                document.getElementById('previewSecretAction2').textContent = 
                    this.appState.secretActions[1] || '입력하지 않음';
                document.getElementById('previewSecretAction3').textContent = 
                    this.appState.secretActions[2] || '입력하지 않음';
                
                // 최종 약속 업데이트
                document.getElementById('previewFinalPromise').textContent = 
                    this.appState.finalPromise || '입력하지 않음';
                
                // 이미지 업데이트
                this.updatePreviewImage('magicWord');
                this.updatePreviewImage('secretAction');
                this.updatePreviewImage('promise');
            }

            updatePreviewImage(imageType) {
                const previewImg = document.getElementById(`preview${imageType.charAt(0).toUpperCase() + imageType.slice(1)}Image`);
                
                if (this.appState.images[imageType]) {
                    previewImg.src = this.appState.images[imageType];
                    previewImg.style.display = 'block';
                } else {
                    previewImg.style.display = 'none';
                }
            }

            togglePreview() {
                this.updatePreview();
                
                if (this.elements.previewAreaContainer.style.display === 'none') {
                    this.elements.previewAreaContainer.style.display = 'block';
                    this.elements.previewAreaContainer.scrollIntoView({ behavior: 'smooth' });
                } else {
                    this.elements.previewAreaContainer.style.display = 'none';
                }
            }

            generateFileName(baseName, extension) {
                const studentInfo = this.appState.studentInfo.trim();
                let studentName = '학생';
                
                if (studentInfo) {
                    const nameMatch = studentInfo.match(/([가-힣]+)$/);
                    if (nameMatch && nameMatch[1]) {
                        studentName = nameMatch[1];
                    }
                }
                
                const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
                return `${baseName}_${studentName}_${timestamp}.${extension}`;
            }

            showLoading() { 
                this.elements.loadingIndicator.style.display = 'block'; 
            }

            hideLoading() { 
                this.elements.loadingIndicator.style.display = 'none'; 
            }

            async saveAsImage() {
                if (typeof html2canvas === 'undefined') {
                    alert('오류: html2canvas 라이브러리를 로드할 수 없습니다.'); 
                    return;
                }
                
                try {
                    this.showLoading();
                    this.updatePreview();

                    const initiallyHidden = this.elements.previewAreaContainer.style.display === 'none';
                    if (initiallyHidden) this.elements.previewAreaContainer.style.display = 'block';

                    const canvas = await html2canvas(this.elements.previewArea, { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        backgroundColor: '#ffffff' 
                    });
                    
                    if (initiallyHidden) this.elements.previewAreaContainer.style.display = 'none';
                    
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = this.generateFileName('친구색깔찾기_비밀작전', 'png');
                    link.href = image;
                    link.click();
                } catch (err) {
                    console.error('이미지 저장 중 오류:', err);
                    alert('이미지 저장 중 오류가 발생했습니다.');
                } finally {
                    this.hideLoading();
                }
            }

            async saveAsPdf() {
                if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
                    alert('오류: 필수 라이브러리를 로드할 수 없습니다.'); 
                    return;
                }
                
                try {
                    this.showLoading();
                    this.updatePreview();
                    
                    const initiallyHidden = this.elements.previewAreaContainer.style.display === 'none';
                    if (initiallyHidden) this.elements.previewAreaContainer.style.display = 'block';

                    const { jsPDF } = jspdf;
                    const canvas = await html2canvas(this.elements.previewArea, { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        backgroundColor: '#ffffff' 
                    });
                    
                    if (initiallyHidden) this.elements.previewAreaContainer.style.display = 'none';
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfPageWidth = pdf.internal.pageSize.getWidth();
                    const pdfPageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    const usableWidth = pdfPageWidth - (margin * 2);
                    const usableHeight = pdfPageHeight - (margin * 2);
                    const aspectRatio = imgProps.width / imgProps.height;
                    
                    let finalImgWidth = usableWidth;
                    let finalImgHeight = finalImgWidth / aspectRatio;

                    if (finalImgHeight > usableHeight) {
                        finalImgHeight = usableHeight;
                        finalImgWidth = finalImgHeight * aspectRatio;
                    }
                    
                    const x = (pdfPageWidth - finalImgWidth) / 2;
                    const y = (pdfPageHeight - finalImgHeight) / 2;

                    pdf.addImage(imgData, 'PNG', x, y, finalImgWidth, finalImgHeight);
                    pdf.save(this.generateFileName('친구색깔찾기_비밀작전', 'pdf'));
                } catch (err) {
                    console.error('PDF 저장 중 오류:', err);
                    alert('PDF 저장 중 오류가 발생했습니다.');
                } finally {
                    this.hideLoading();
                }
            }

            printCard() {
                this.updatePreview();
                
                const printContent = `
                    <div style="font-family: 'Noto Sans KR', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto;">
                        <h1 style="text-align: center; color: #667eea; margin-bottom: 30px; font-size: 24px;">
                            🌟 나의 친구 색깔 찾아주기 비밀작전 완료! 🌟
                        </h1>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #667eea;">
                            <h3 style="color: #2c3e50; margin: 0 0 15px 0;">📋 기본 정보</h3>
                            <p><strong>학교, 학반, 이름:</strong> ${this.appState.studentInfo || '미입력'}</p>
                        </div>
                        
                        <div style="background: #f0f4ff; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #667eea;">
                            <h3 style="color: #667eea; margin: 0 0 15px 0;">🪄 친구에게 힘을 주는 마법 주문</h3>
                            <p>1. ${this.appState.magicWords[0] || '미입력'}</p>
                            <p>2. ${this.appState.magicWords[1] || '미입력'}</p>
                            <p>3. ${this.appState.magicWords[2] || '미입력'}</p>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #11998e;">
                            <h3 style="color: #11998e; margin: 0 0 15px 0;">🕵️ 친구를 웃게 하는 비밀 행동</h3>
                            <p>1. ${this.appState.secretActions[0] || '미입력'}</p>
                            <p>2. ${this.appState.secretActions[1] || '미입력'}</p>
                            <p>3. ${this.appState.secretActions[2] || '미입력'}</p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fef7cd, #fff8dc); padding: 25px; border-radius: 15px; border: 4px solid #d4a574; text-align: center;">
                            <h3 style="color: #8b4513; margin: 0 0 20px 0;">📜 나의 소중한 약속 📜</h3>
                            <p style="font-size: 18px; font-weight: bold; color: #8b4513; line-height: 1.8; margin: 0;">
                                "${this.appState.finalPromise || '미입력'}"
                            </p>
                        </div>
                        
                        <p style="text-align: center; margin-top: 30px; color: #6b7280; font-size: 14px;">
                            🎊 완성일: ${new Date().toLocaleDateString('ko-KR')} 🎊
                        </p>
                    </div>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>나의 친구 색깔 찾아주기 비밀작전 카드</title>
                        <meta charset="UTF-8">
                        <style>
                            body { margin: 0; padding: 20px; font-family: 'Noto Sans KR', sans-serif; }
                            @media print { 
                                body { -webkit-print-color-adjust: exact; color-adjust: exact; } 
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            saveData() {
                try {
                    const dataToSave = {
                        ...this.appState,
                        currentStep: this.currentStep,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('friendshipMissionData', JSON.stringify(dataToSave));
                } catch (error) {
                    console.warn('데이터 저장에 실패했습니다:', error);
                }
            }

            loadSavedData() {
                try {
                    const savedData = localStorage.getItem('friendshipMissionData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        // 기본 정보 복원
                        this.elements.studentInfo.value = data.studentInfo || '';
                        
                        // 마법 주문 복원
                        if (data.magicWords) {
                            this.elements.magicWord1.value = data.magicWords[0] || '';
                            this.elements.magicWord2.value = data.magicWords[1] || '';
                            this.elements.magicWord3.value = data.magicWords[2] || '';
                        }
                        
                        // 비밀 행동 복원
                        if (data.secretActions) {
                            this.elements.secretAction1.value = data.secretActions[0] || '';
                            this.elements.secretAction2.value = data.secretActions[1] || '';
                            this.elements.secretAction3.value = data.secretActions[2] || '';
                        }
                        
                        // 최종 약속 복원
                        this.elements.finalPromise.value = data.finalPromise || '';
                        
                        // 이미지 복원
                        if (data.images) {
                            Object.keys(data.images).forEach(imageType => {
                                if (data.images[imageType]) {
                                    this.appState.images[imageType] = data.images[imageType];
                                    this.updateImagePreview(imageType, data.images[imageType]);
                                }
                            });
                        }
                        
                        this.updateAppState();
                    }
                } catch (error) {
                    console.warn('저장된 데이터를 불러올 수 없습니다:', error);
                }
            }

            resetAll() {
                if (confirm('모든 입력 내용이 삭제됩니다. 계속하시겠습니까?')) {
                    // 모든 입력 초기화
                    Object.values(this.elements).forEach(element => {
                        if (element && (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA')) {
                            element.value = '';
                        }
                    });
                    
                    // 이미지 초기화
                    this.clearImage('magicWord');
                    this.clearImage('secretAction');
                    this.clearImage('promise');
                    
                    // 상태 초기화
                    this.appState = {
                        studentInfo: '',
                        magicWords: ['', '', ''],
                        secretActions: ['', '', ''],
                        finalPromise: '',
                        images: {
                            magicWord: null,
                            secretAction: null,
                            promise: null
                        }
                    };
                    
                    // 피드백 숨김
                    document.querySelectorAll('.input-feedback').forEach(feedback => {
                        feedback.style.display = 'none';
                    });
                    
                    // 완료 메시지 숨김
                    document.getElementById('completionMessage').style.display = 'none';
                    
                    // 첫 번째 단계로 돌아가기
                    this.goToStep(1);
                    this.elements.previewAreaContainer.style.display = 'none';
                    
                    // 로컬 스토리지 초기화
                    localStorage.removeItem('friendshipMissionData');
                    
                    alert('모든 내용이 초기화되었습니다. 새로운 비밀 작전을 시작해보세요! 🌟');
                }
            }
        }

        // 애플리케이션 초기화
        document.addEventListener('DOMContentLoaded', () => {
            new FriendshipMissionApp();
        });
    </script>
</body>
</html>